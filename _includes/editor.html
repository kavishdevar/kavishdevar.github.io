<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"
    integrity="sha512-LhccdVNGe2QMEfI3x4DVV3ckMRe36TfydKss6mJpdHjNFiV07dFpS2xzeZedptKZrwxfICJpez09iNioiSZ3hA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<div>
    <div class="editor">
        <div id="titles">
            <md-outlined-text-field id="title-input" label="Title" maxlength="60"
                style="width: 100%;"></md-outlined-text-field>
            <br>
            <md-outlined-text-field id="subtitle-input" label="Subtitle" maxlength="150"
                style="width: 100%;"></md-outlined-text-field>
        </div>
        <div id="inputs" style="display: flex;">
            <style>
                #markdown-input {
                    margin-top: 10px;
                    margin-right: 30px;
                    height: 80dvh;
                    width: 100%;
                }
            </style>
            <md-outlined-text-field id="markdown-input" type="textarea" label="Content"></md-outlined-text-field>
            <md-filled-card class="card" style="height: 80dvh;">
                <div class="card__header">
                    <div class="card__header-text">
                        <div class="card__title">
                            <h1 id="card-title" style="font-size: 1.8em;"></h1>
                        </div>
                        <div class="card__subtitle">
                            <h3 id="card-subtitle"></h3>
                        </div>
                    </div>
                </div>
                <div class="card__secondary" style="font-size: 1em;" id="markdown-preview">
                </div>
            </md-filled-card>
        </div>
        <md-filled-button id="save-button" style="margin-top: 10px;">Save</md-filled-button>
    </div>
</div>

<script type="module">
    import { Octokit } from "https://esm.sh/@octokit/core";
    AUTH_TOKEN = "{{ site.env.OCTOKIT_AUTH }}";
    setTimeout(() => {
        var fileExists = false;
        var sha = ''
        var originalContents = '';

        async function save() {
            const markdownText = document.getElementById('markdown-input').value;
            const title = document.getElementById('title-input').value;
            const subtitle = document.getElementById('subtitle-input').value;
            var text = `---
layout: default
title: ${title}
subtitle: ${subtitle}
titleForNav: ${title}
date: ${new Date().toISOString()}
author: kavish
---
${markdownText}
`;
            if (!title || !subtitle || !markdownText) {
                alert('Please fill all the fields');
                return;
            }
            variable = OCTOKIT_AUTH
            var octokit = new Octokit({
                auth: auth_token
            })
            var filename = new Date().toISOString().split('T')[0] + '-' + title.toLowerCase().split(' ').join('-') + '.md';

            await octokit.request('GET /repos/kavishdevar/kavishdevar.github.io/contents/_posts/' + filename).then(response => {
                sha = response.data.sha;
                originalContents = atob(response.data.content);
                fileExists = true;
            }).catch(error => {
                fileExists = false;
            });

            if (fileExists) {
                // remove lines that are not part of the content
                originalContents = originalContents.split('---').slice(2).join('---');
                text = text.split('---').slice(2).join('---');
                if (originalContents.trim() === text.trim()) {
                    alert('File already exists, and no changes were made.');
                    return;
                }
                var overwrite = confirm('Do you want to overwrite the file?');
                if (overwrite) {
                    text = text.split('---').slice(0, 2).join('---') + '\nedited: ' + new Date().toISOString() + '\n' + text.split('---').slice(2).join('---');
                    await octokit.request('PUT /repos/kavishdevar/kavishdevar.github.io/contents/_posts/' + filename, {
                        owner: 'kavisdevar',
                        repo: 'kavishdevar',
                        path: '/_posts/' + filename,
                        message: 'Add File',
                        sha: sha,
                        committer: {
                            name: 'Web Editor',
                            email: 'web.editor@kavishdevar.me'
                        },
                        content: btoa(text),
                        headers: {
                            'X-GitHub-Api-Version': '2022-11-28'
                        }
                    }).then(response => {
                        alert('Saved Successfully');
                    }).catch(error => {
                        console.log(error);
                        alert('Error Occured');
                    });
                }
                else {
                    alert('Please change the title and try again');
                }
                return;
            }
            else if (!fileExists) {
                await octokit.request('PUT /repos/kavishdevar/kavishdevar.github.io/contents/_posts/' + filename, {
                    owner: 'kavisdevar',
                    repo: 'kavishdevar',
                    path: '/_posts/' + filename,
                    message: 'Add File',
                    committer: {
                        name: 'Web Editor',
                        email: 'web.editor@kavishdevar.me'
                    },
                    content: btoa(text),
                    headers: {
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                }).then(response => {
                    alert('Saved Successfully');
                }).catch(error => {
                    alert('Error Occured');
                });
            }
        }
        const saveButton = document.getElementById('save-button');
        saveButton.addEventListener('click', save);
        const markdownInput = document.getElementById('markdown-input');
        const markdownPreview = document.getElementById('markdown-preview');
        const titleInput = document.getElementById('title-input');
        const subtitleInput = document.getElementById('subtitle-input');
        const cardTitle = document.getElementById('card-title');
        const cardSubtitle = document.getElementById('card-subtitle');

        const valuesUpdated = () => {
            cardTitle.innerHTML = titleInput.value;
            cardSubtitle.innerHTML = subtitleInput.value;
            const markdownText = markdownInput.value;
            const converter = new showdown.Converter();
            const html = converter.makeHtml(markdownText).replace('h6', 'h7').replace('h5', 'h6').replace('h4', 'h5').replace('h3', 'h4').replace('h2', 'h3').replace('h1', 'h2');
            markdownPreview.innerHTML = html;
            localStorage.setItem('markdown', markdownText);
            localStorage.setItem('title', titleInput.value);
            localStorage.setItem('subtitle', subtitleInput.value);
        };
        const getValues = () => {
            const markdownText = localStorage.getItem('markdown');
            const title = localStorage.getItem('title');
            const subtitle = localStorage.getItem('subtitle');
            if (markdownText) {
                markdownInput.value = markdownText;
                titleInput.value = title;
                subtitleInput.value = subtitle;
                valuesUpdated();
            }
        }
        // Add event listener to update the preview whenever the input changes
        markdownInput.addEventListener('input', valuesUpdated);
        titleInput.addEventListener('input', valuesUpdated);
        subtitleInput.addEventListener('input', valuesUpdated);
        // Initial preview update
        getValues()
    }, 2000);
</script>